---
- name: Download metallb remote namespace config
  get_url: 
    url: "https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/manifests/namespace.yaml"
    dest: "{{ role_path }}/files/"

- name: Download metallb remote config
  get_url: 
    url: "https://raw.githubusercontent.com/metallb/metallb/{{ metallb_version }}/manifests/metallb.yaml"
    dest: "{{ role_path }}/files/"

- name: Deploy metallb name space
  k8s:
    state: "{{ workload_state }}"
    src: "{{ role_path }}/files/namespace.yaml"

- name: Deploy metallb
  k8s:
    state: "{{ workload_state }}"
    src: "{{ role_path }}/files/metallb.yaml"

- name: Deploy Metallb secretkey
  k8s:
    state: "{{ workload_state }}"
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: memberlist
        namespace: metallb-system
      type: Opaque
      data:
        secretkey: "{{ metallb_secretkey }}"

- name: Deploy Metallb config
  k8s:
    state: "{{ workload_state }}"
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        namespace: metallb-system
        name: config
      data:
        config: "{{ metallb_config }}"